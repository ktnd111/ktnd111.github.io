<!DOCTYPE html>
<link rel="stylesheet" href="../css/common.css">
<style>
    header {
        background-color: #333;
        position: relative;
        overflow: hidden;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px;
    }
    
    .header-content {
        position: relative;
        z-index: 10;
        color: #ffffff;
    }
    
    .header-subtitle {
        font-size: 14px;
        color: #bbbbbb;
        margin: 4px 0 0 0;
    }
    
    .contribution-grid {
        position: absolute;
        top: 0;
        right: 0;
        height: 100%;
        width: 50%;
        display: grid;
        grid-template-columns: repeat(20, 1fr);
        grid-template-rows: repeat(7, 1fr);
        gap: 2px;
        padding: 4px;
        opacity: 0;
        transition: opacity 1s ease-in-out;
        box-sizing: border-box;
    }
    
    .contribution-grid.loaded {
        opacity: 0.7;
    }
    
    .contribution-cell {
        border-radius: 2px;
    }
    
    .contribution-level-0 { background-color: #444; }
    .contribution-level-1 { background-color: #9be9a8; }
    .contribution-level-2 { background-color: #40c463; }
    .contribution-level-3 { background-color: #30a14e; }
    .contribution-level-4 { background-color: #216e39; }
</style>
<header>
    <h1><a href="../index.html">KTND111's Personal.GITHUB.IO</a></h1>
    <div class="contribution-grid" id="contribution-grid"></div>
</header>

<script>
    // GitHub APIからktnd111のコントリビューションデータを取得
    async function fetchContributionData() {
        try {
            const username = 'ktnd111';
            console.log('Fetching GitHub contributions for:', username);
            
            // 直接データを取得してみる
            const url = `https://github-contributions-api.jogruber.de/v4/${username}`;
            console.log('Requesting from URL:', url);
            
            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json'
                },
                // CORSエラーを回避するためのモード
                mode: 'cors',
                cache: 'no-cache'
            });
            
            console.log('Response status:', response.status);
            
            if (!response.ok) {
                console.warn('API response not OK:', response.status, response.statusText);
                // エラー時はフォールバックデータを使用
                return generateFallbackData(); 
            }
            
            const contributionData = await response.json();
            console.log('Data received, contributions count:', 
                        contributionData.contributions ? contributionData.contributions.length : 0);
            
            // 最新140日分のデータを取得（20列×7行）
            const contributions = contributionData.contributions || [];
            
            if (contributions.length === 0) {
                console.warn('No contribution data found');
                return generateFallbackData();
            }
            
            const recentContributions = contributions.slice(-140);
            console.log('Using most recent contributions:', recentContributions.length);
            
            // 貢献度レベルに変換（0-4）
            return recentContributions.map(day => {
                const count = day.count || 0;
                // GitHubの貢献度を0-4のレベルに変換
                if (count === 0) return 0;
                if (count <= 2) return 1;
                if (count <= 5) return 2;
                if (count <= 10) return 3;
                return 4;
            });
        } catch (error) {
            console.error('コントリビューションデータの取得に失敗しました:', error);
            // エラーが発生した場合はデモデータを返す
            return generateFallbackData();
        }
    }
    
    // フォールバック用のデモデータを生成（よりパターン化）
    function generateFallbackData() {
        console.log('Generating fallback contribution data');
        const days = 20 * 7; // グリッドのセル数
        const data = [];
        
        // デモパターンを生成
        for (let i = 0; i < days; i++) {
            // 行と列の位置を計算
            const row = Math.floor(i / 20);
            const col = i % 20;
            
            // 様々なパターンを作る
            let level = 0;
            
            // Kの形を描く
            if (col === 0 || // 縦線
                (row === 3 && col >= 0 && col <= 10) || // 中央の横線
                (row >= 0 && col >= 0 && row + col === 10 && col <= 10) || // 左下の斜め線
                (row >= 0 && col >= 0 && col - row === 4 && col <= 10)) { // 右上の斜め線
                level = Math.floor(Math.random() * 3) + 2; // レベル2-4
            } else {
                // その他のセルはランダムで低いレベル
                level = Math.random() > 0.75 ? Math.floor(Math.random() * 2) + 1 : 0;
            }
            
            data.push(level);
        }
        
        return data;
    }
    
    // コントリビューショングリッドの描画
    async function renderContributionGrid() {
        console.log('Starting to render contribution grid');
        const grid = document.getElementById('contribution-grid');
        
        if (!grid) {
            console.error('Contribution grid element not found!');
            return;
        }
        
        // グリッドをクリア
        grid.innerHTML = '';
        
        try {
            // データを取得
            const data = await fetchContributionData();
            console.log('Retrieved contribution data, length:', data.length);
            
            if (!data || data.length === 0) {
                console.error('No data available for grid');
                return;
            }
            
            // セルを作成
            data.forEach((level, index) => {
                const cell = document.createElement('div');
                cell.className = `contribution-cell contribution-level-${level}`;
                
                // 日付を計算（最新のデータが右下にくるように逆順に表示）
                const today = new Date();
                const pastDate = new Date(today);
                pastDate.setDate(today.getDate() - (data.length - 1 - index));
                
                const dateStr = pastDate.toLocaleDateString();
                cell.title = `${dateStr}: レベル ${level} の貢献`;
                
                grid.appendChild(cell);
            });
            
            console.log('Grid cells created:', grid.children.length);
        } catch (error) {
            console.error('Error rendering contribution grid:', error);
            // エラー時にはフォールバックグリッドを表示
            generateFallbackData().forEach((level) => {
                const cell = document.createElement('div');
                cell.className = `contribution-cell contribution-level-${level}`;
                grid.appendChild(cell);
            });
        }
        
        // フェードインアニメーション
        console.log('Triggering fade-in animation');
        setTimeout(() => {
            grid.classList.add('loaded');
        }, 100);
    }
    
    // ページ読み込み時にグリッドを描画
    console.log('Setting up DOMContentLoaded listener');
    document.addEventListener('DOMContentLoaded', renderContributionGrid);
    
    // すでにDOMがロード済みの場合（遅延読み込みなど）の対策
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
        console.log('DOM already loaded, rendering immediately');
        setTimeout(renderContributionGrid, 1);
    }
</script>