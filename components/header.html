<!DOCTYPE html>
<link rel="stylesheet" href="../css/common.css">
<style>
    header {
        background-color: #333;
        position: relative;
        overflow: hidden;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px;
    }
    
    .header-content {
        position: relative;
        z-index: 10;
        color: #ffffff;
    }
    
    .header-subtitle {
        font-size: 14px;
        color: #bbbbbb;
        margin: 4px 0 0 0;
    }
    
    .contribution-grid {
        position: absolute;
        top: 0;
        right: 0;
        height: 100%;
        width: 50%;
        display: grid;
        grid-template-columns: repeat(20, 1fr);
        grid-template-rows: repeat(7, 1fr);
        gap: 2px;
        padding: 4px;
        opacity: 0;
        transition: opacity 1s ease-in-out;
        box-sizing: border-box;
    }
    
    .contribution-grid.loaded {
        opacity: 0.7;
    }
    
    .contribution-cell {
        border-radius: 2px;
    }
    
    .contribution-level-0 { background-color: #444; }
    .contribution-level-1 { background-color: #9be9a8; }
    .contribution-level-2 { background-color: #40c463; }
    .contribution-level-3 { background-color: #30a14e; }
    .contribution-level-4 { background-color: #216e39; }
</style>
<header>
    <h1><a href="../index.html">KTND111's Personal.GITHUB.IO</a></h1>
    <div class="contribution-grid" id="contribution-grid"></div>
</header>

<script>
    // ローカルのJSONファイルからコントリビューションデータを取得
    async function fetchContributionData() {
        try {
            console.log('Fetching contribution data from local JSON file');
            const response = await fetch('../data/contributions.json');
            
            if (!response.ok) {
                console.warn('JSON file not found or error:', response.status);
                return generateFallbackData();
            }
            
            const data = await response.json();
            console.log('Contribution data loaded, last updated:', data.updated_at);
            
            // 設定されたlevelプロパティを使用
            return data.contributions.map(day => day.level);
        } catch (error) {
            console.error('Error loading contribution data:', error);
            return generateFallbackData();
        }
    }
    
    // フォールバック用のデモデータを生成
    function generateFallbackData() {
        console.log('Generating fallback contribution data');
        const days = 20 * 7; // グリッドのセル数
        const data = [];
        
        // デモパターンを生成
        for (let i = 0; i < days; i++) {
            // 行と列の位置を計算
            const row = Math.floor(i / 20);
            const col = i % 20;
            
            // 様々なパターンを作る
            let level = 0;
            
            // Kの形を描く
            if (col === 0 || // 縦線
                (row === 3 && col <= 10) || // 中央の横線
                (col <= 10 && row + col === 10) || // 左下の斜め線
                (col <= 10 && col - row === 4)) { // 右上の斜め線
                level = Math.floor(Math.random() * 3) + 2; // レベル2-4
            } else {
                // その他のセルはランダムで低いレベル
                level = Math.random() > 0.75 ? Math.floor(Math.random() * 2) + 1 : 0;
            }
            
            data.push(level);
        }
        
        return data;
    }
    
    // コントリビューショングリッドの描画
    async function renderContributionGrid() {
        console.log('Rendering contribution grid');
        const grid = document.getElementById('contribution-grid');
        
        if (!grid) {
            console.error('Grid element not found');
            return;
        }
        
        // グリッドをクリア
        grid.innerHTML = '';
        
        try {
            // データを取得
            const data = await fetchContributionData();
            
            if (!data || data.length === 0) {
                throw new Error('No data available');
            }
            
            // セルを作成
            data.forEach((level, index) => {
                const cell = document.createElement('div');
                cell.className = `contribution-cell contribution-level-${level}`;
                
                // 日付を計算（最新のデータが右下にくるように逆順に表示）
                const today = new Date();
                const pastDate = new Date(today);
                pastDate.setDate(today.getDate() - (data.length - 1 - index));
                
                const dateStr = pastDate.toLocaleDateString();
                cell.title = `${dateStr}: レベル ${level} の貢献`;
                
                grid.appendChild(cell);
            });
            
            console.log('Grid rendered with', grid.children.length, 'cells');
        } catch (error) {
            console.error('Error in rendering:', error);
            // エラー時にはフォールバックグリッドを表示
            generateFallbackData().forEach((level) => {
                const cell = document.createElement('div');
                cell.className = `contribution-cell contribution-level-${level}`;
                grid.appendChild(cell);
            });
        }
        
        // フェードインアニメーション
        setTimeout(() => {
            grid.classList.add('loaded');
            console.log('Fade-in animation triggered');
        }, 100);
    }
    
    // ページ読み込み時にグリッドを描画
    document.addEventListener('DOMContentLoaded', renderContributionGrid);
    
    // すでにDOMがロード済みの場合の対策
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
        setTimeout(renderContributionGrid, 1);
    }
</script>