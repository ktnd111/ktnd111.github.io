# 早期リターン（Guard Clause）でネスト地獄を回避しよう【C#実践Tips】

複雑な条件分岐が重なると、気づけば `if` の入れ子が深くなって「読みにくいコード」になっていた……という経験、あると思います。

そこで今回は、**読みやすく・実務で即使える**「早期リターン（Guard Clause）」について、Before/Afterの具体例とともに紹介します。考え方もシンプルで効果がわかりやすく、初心者〜中級者にとってもちょうどいいネタです。

余談ですが「早期リターン」は英語では Guard Clause（ガード・クロース）と呼ばれています。
より詳細に表現するなら、「無効な条件を早期に弾き出す防御壁」のような意味で、不適切な入力や条件が関数の深部まで進むのを防ぐ手法です。
日本語では処理を「早めに終了させて戻る」という動作に着目して「早期リターン」という呼び方が定着しています。

## Before：ネストが深いコード
```csharp
public bool ProcessOrder(Order order)
{
    if (order != null)
    {
        if (order.IsPaid)
        {
            if (!order.IsShipped)
            {
                // ここで出荷処理
                Ship(order);
                return true;
            }
        }
    }
    return false;
}
```

## After：早期リターンでガード
```csharp
public bool ProcessOrder(Order order)
{
    if (order is null)           return false;
    if (!order.IsPaid)           return false;
    if (order.IsShipped)         return false;

    Ship(order);
    return true;
}
```

> **ポイント**
> - "処理できないケース" を否定形で先に弾く
> - インデントを浅く保つことで、視線移動が上下で済むようになり、コードの読みやすさがグッと上がる

---

## なぜ早期リターン？

`if` がどんどん深くなると、**どの条件で何が起きるのか**を把握するのが一気に難しくなります。

早期リターン（Guard Clause）は、その逆。「ダメなパターンを先に返す」ことで、正常処理の流れをスッキリさせる考え方です。

実際に使ってみると、その効果はすぐに体感できると思います。

---

## 基本パターン3つ

### 1. nullチェック
```csharp
if (input == null) return;
```

### 2. 引数バリデーション
```csharp
if (amount <= 0) return;
```

### 3. 状態ガード（フラグや状態で処理を止める）
```csharp
if (!user.IsActive) return;
```

---

## メリットと注意点

### 👍 メリット
- 可読性が高く、処理の意図が明確
- テストケースが書きやすい（早期終了パターンが増える）
- 差分レビューがラク（深いインデントがないと、変更箇所が見やすい）

### ⚠️ 注意点
- `return` が増えすぎると「処理の流れ」が見えにくくなることも
- 複雑になってきたら、小さなメソッドに分けるのも選択肢のひとつです

---

## 実務Tips：よりうまく使うために

### 失敗時はログを出す
```csharp
if (!order.IsValid)
{
    logger.LogWarning("注文が無効です");
    return;
}
```

### return と throw の使い分け
- **recoverable（復帰できる）** → `return`
- **critical（致命的な異常）** → `throw`

このあたりは、業務アプリの要件や開発方針に合わせて調整するとよいです。

---

## まとめ：判断基準を持っておくと楽になる

- [ ] インデントが2段以上になっていないか？
- [ ] 「この条件、先に抜けられない？」と考えてみる
- [ ] 処理の本道（正常系）をシンプルに書けているか？

早期リターンは、ちょっとした書き方の工夫でコードの見通しが良くなるテクニックです。
「これ、ちょっとネスト深いな」と感じたときは、ぜひ思い出して使ってみてください。

---
